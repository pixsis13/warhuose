{% extends 'inventory/base.html' %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-center mb-8">
    <h1 class="text-3xl font-bold dark:text-white">داشبورد مدیریتی</h1>
    <div class="flex gap-2 mt-4 md:mt-0">
        <a href="{% url 'category_create' %}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow transition">
            + دسته جدید
        </a>
        <a href="{% url 'export_products_csv' %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center">
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            دانلود گزارش اکسل
        </a>
    </div>
</div>

<!-- آمار کلی (Cards) -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- کارت 1 -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow border-r-4 border-blue-500">
        <div class="text-gray-500 dark:text-gray-400 text-sm">تعداد کالا</div>
        <div class="text-3xl font-bold text-gray-800 dark:text-white">{{ total_products }}</div>
    </div>
    <!-- کارت 2 -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow border-r-4 border-green-500">
        <div class="text-gray-500 dark:text-gray-400 text-sm">مجموع موجودی</div>
        <div class="text-3xl font-bold text-gray-800 dark:text-white">{{ total_quantity }}</div>
    </div>
    <!-- کارت 3 -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow border-r-4 border-purple-500">
        <div class="text-gray-500 dark:text-gray-400 text-sm">ارزش انبار</div>
        <div class="text-xl font-bold text-gray-800 dark:text-white">{{ total_value }} <span class="text-xs">تومان</span></div>
    </div>
    <!-- کارت 4 -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow border-r-4 border-red-500">
        <div class="text-gray-500 dark:text-gray-400 text-sm">هشدار کمبود</div>
        <div class="text-3xl font-bold text-red-500">{{ low_stock_count }}</div>
    </div>
</div>

<!-- نمودارها -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- نمودار 1: دسته‌بندی‌ها -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
        <h3 class="text-lg font-bold mb-4 text-gray-700 dark:text-gray-200 border-b dark:border-gray-700 pb-2">توزیع دسته‌بندی‌ها</h3>
        <div class="relative h-64 w-full flex justify-center">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <!-- نمودار 2: موجودی کالاها -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
        <h3 class="text-lg font-bold mb-4 text-gray-700 dark:text-gray-200 border-b dark:border-gray-700 pb-2">پر موجودی‌ترین کالاها</h3>
        <div class="relative h-64 w-full">
            <canvas id="productChart"></canvas>
        </div>
    </div>
</div>

<script>
    // دریافت داده‌ها از ویو
    const catNames = JSON.parse('{{ chart_cat_names|safe }}');
    const catCounts = JSON.parse('{{ chart_cat_counts|safe }}');
    const prodNames = JSON.parse('{{ chart_prod_names|safe }}');
    const prodQuantities = JSON.parse('{{ chart_prod_quantities|safe }}');

    // تنظیمات رنگ متن بر اساس تم (ساده)
    const textColor = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151';

    // نمودار دایره‌ای
    new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
            labels: catNames,
            datasets: [{
                data: catCounts,
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: textColor } }
            }
        }
    });

    // نمودار میله‌ای
    new Chart(document.getElementById('productChart'), {
        type: 'bar',
        data: {
            labels: prodNames,
            datasets: [{
                label: 'موجودی',
                data: prodQuantities,
                backgroundColor: '#3b82f6',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { ticks: { color: textColor }, grid: { color: '#4b556333' } },
                x: { ticks: { color: textColor }, grid: { display: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
</script>
{% endblock %}
